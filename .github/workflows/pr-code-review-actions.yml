name: PR Code Review with Dify (No Fork PR)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  # PRãŒãªã„å ´åˆï¼ˆæ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ãªã©ï¼‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ 
  group: pr-code-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  code-review:
    runs-on: ubuntu-latest
    # ãƒ‰ãƒ©ãƒ•ãƒˆPRã¯ã‚¹ã‚­ãƒƒãƒ— + fork PRã¯å¯¾è±¡å¤–ï¼ˆåŒä¸€ãƒªãƒã‚¸ãƒˆãƒªPRã®ã¿ï¼‰
    if: ${{ github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨PRæƒ…å ±ã‚’ä¸€æ‹¬å–å¾—
      - name: Collect PR and files metadata
        id: pr-data
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã§ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
            const per_page = 100;
            let page = 1;
            let files = [];
            const maxFiles = 300; // æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™

            while (files.length < maxFiles) {
              const res = await github.request('GET /repos/{owner}/{repo}/pulls/{pull_number}/files', {
                owner,
                repo,
                pull_number: pr.number,
                per_page,
                page
              });

              files.push(...res.data.map(f => ({
                filename: f.filename,
                status: f.status,
                additions: f.additions,
                deletions: f.deletions,
                changes: f.changes,
                previous_filename: f.previous_filename ?? null
              })));

              if (res.data.length < per_page) break;
              page++;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã¯è­¦å‘Š
            if (files.length >= maxFiles) {
              core.warning(`File count exceeds ${maxFiles}. Only first ${maxFiles} files will be reviewed.`);
              files = files.slice(0, maxFiles);
            }

            // å‡ºåŠ›ã‚’è¨­å®š
            core.setOutput('files_meta_json', JSON.stringify(files));
            core.setOutput('file_count', files.length);
            core.setOutput('owner', owner);
            core.setOutput('repo', repo);
            core.setOutput('pr_number', pr.number.toString());
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_sha', pr.base.sha);
            core.setOutput('pr_url', pr.html_url);

            // PR ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœãƒ‡ã‚£ã¯è¤‡æ•°è¡Œãƒ»ç‰¹æ®Šæ–‡å­—å¯¾å¿œã®ãŸã‚ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™
            core.exportVariable('PR_TITLE', pr.title || '');
            core.exportVariable('PR_BODY', pr.body || '');

      - name: Call Dify Workflow for Code Review
        id: dify-review
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_WORKFLOW_URL: ${{ secrets.DIFY_WORKFLOW_URL }}
          # PRæƒ…å ±ã¯ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æ¸¡ã™ï¼ˆã‚·ã‚§ãƒ«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
          OWNER: ${{ steps.pr-data.outputs.owner }}
          REPO: ${{ steps.pr-data.outputs.repo }}
          PR_NUMBER: ${{ steps.pr-data.outputs.pr_number }}
          PR_URL: ${{ steps.pr-data.outputs.pr_url }}
          HEAD_SHA: ${{ steps.pr-data.outputs.head_sha }}
          BASE_SHA: ${{ steps.pr-data.outputs.base_sha }}
          FILES_META_JSON: ${{ steps.pr-data.outputs.files_meta_json }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail

          # å¿…é ˆç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
          if [[ -z "${DIFY_API_KEY:-}" ]]; then
            echo "::error::DIFY_API_KEY is not set"
            exit 1
          fi
          if [[ -z "${DIFY_WORKFLOW_URL:-}" ]]; then
            echo "::error::DIFY_WORKFLOW_URL is not set"
            exit 1
          fi

          # jqã§å®‰å…¨ã«JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
          # å…¨ã¦ã®å€¤ã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹ã“ã¨ã§ã‚·ã‚§ãƒ«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’é˜²æ­¢
          payload="$(jq -n \
            --arg owner "$OWNER" \
            --arg repo "$REPO" \
            --arg pr_number "$PR_NUMBER" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_body "$PR_BODY" \
            --arg pr_url "$PR_URL" \
            --arg head_sha "$HEAD_SHA" \
            --arg base_sha "$BASE_SHA" \
            --arg files_meta_json "$FILES_META_JSON" \
            --arg user "github-actions:${OWNER}/${REPO}#${PR_NUMBER}" \
            '{
              inputs: {
                owner: $owner,
                repo: $repo,
                pr_number: $pr_number,
                pr_title: $pr_title,
                pr_body: $pr_body,
                pr_url: $pr_url,
                head_sha: $head_sha,
                base_sha: $base_sha,
                files_meta_json: $files_meta_json
              },
              response_mode: "blocking",
              user: $user
            }'
          )"

          echo "::debug::Payload size: $(echo "$payload" | wc -c) bytes"

          # Dify Workflow APIã‚’å‘¼ã³å‡ºã—
          # --fail-with-body: ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’å–å¾—
          # -w ã§ HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æœ«å°¾ã«è¿½åŠ 
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --max-time 300 \
            --location \
            --request POST "${DIFY_WORKFLOW_URL}" \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header "Content-Type: application/json" \
            --data-raw "$payload") || {
            echo "::error::curl command failed"
            exit 1
          }

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

          echo "::group::Dify API Response"
          echo "HTTP Status Code: $HTTP_CODE"
          echo "Response Body:"
          echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
          echo "::endgroup::"

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          if [[ "$HTTP_CODE" -ge 400 ]]; then
            echo "::error::Dify API returned HTTP $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
          REVIEW_RESULT=$(echo "$RESPONSE_BODY" | jq -r '
            .data.outputs.review_result //
            .outputs.review_result //
            .data.text //
            empty
          ')

          if [[ -z "$REVIEW_RESULT" ]]; then
            echo "::warning::Failed to extract review_result from Dify response"
            echo "Response structure:"
            echo "$RESPONSE_BODY" | jq 'keys' 2>/dev/null || echo "Unable to parse JSON"
            
            # ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãè­¦å‘Šã¨ã—ã¦ç¶šè¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
            # ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
            read -r -d '' REVIEW_RESULT <<FALLBACK_MSG || true
âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚

Dify APIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**HTTP Status**: ${HTTP_CODE}
**Run ID**: ${RUN_ID}
FALLBACK_MSG
          fi

          # è¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼ï¼‰
          {
            echo 'REVIEW_RESULT<<GITHUB_ENV_EOF'
            echo "$REVIEW_RESULT"
            echo 'GITHUB_ENV_EOF'
          } >> "$GITHUB_ENV"

          echo "::notice::Code review completed successfully"

      - name: Post Review Comment to PR
        uses: actions/github-script@v7
        if: always() && env.REVIEW_RESULT != ''
        with:
          github-token: ${{ github.token }}
          script: |
            const reviewResult = process.env.REVIEW_RESULT;
            
            if (!reviewResult) {
              console.log('No review result to post');
              return;
            }

            const prNumber = ${{ github.event.pull_request.number }};
            const headSha = '${{ github.event.pull_request.head.sha }}';
            const shortSha = headSha.substring(0, 7);
            const runId = '${{ github.run_id }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId}`;
            
            const commentBody = `## ğŸ¤– AI Code Review

${reviewResult}

---
<details>
<summary>â„¹ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±</summary>

- **PR**: #${prNumber}
- **Commit**: \`${shortSha}\`
- **Workflow Run**: [${runId}](${runUrl})
- **Generated by**: Dify + Azure OpenAI

</details>`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Review comment posted successfully');
            } catch (error) {
              core.setFailed(`Failed to post comment: ${error.message}`);
            }

      - name: Handle Error
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const runId = '${{ github.run_id }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId}`;
            
            const errorBody = `## âš ï¸ AI Code Review Failed

ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

### ç¢ºèªäº‹é …
1. \`DIFY_API_KEY\` ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. \`DIFY_WORKFLOW_URL\` ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
3. Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹

### ãƒ‡ãƒãƒƒã‚°æƒ…å ±
- **Workflow Run**: [${runId}](${runUrl})
- **PR**: #${prNumber}

---
*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚*`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: errorBody
              });
            } catch (commentError) {
              console.error('Failed to post error comment:', commentError.message);
            }
