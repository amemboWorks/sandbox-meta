# PR Code Review with Dify + Azure OpenAI

GitHub Pull Requestに対して、AIによる自動コードレビューを実行するシステムです。

## 概要

PRが作成・更新されると、GitHub Actionsが起動し、Difyワークフロー経由でAzure OpenAI（GPT-4o）がコードレビューを実施します。レビュー結果はPRコメントとして自動投稿されます。

### 特徴

- **ファイル優先度ソート**: Webサイト開発向けに最適化（コンポーネント > ロジック > スタイル > ドキュメント）
- **漏れのないレビュー**: 全ファイルに対してコメントを生成（差分が取得できない場合も理由付きコメントを出力）
- **大規模PR対応**: 最大300ファイル（GitHub REST API 3ページ分）まで対応
- **セキュリティ対策**: fork PRを対象外、入力はjq経由で安全にJSON化（シェルインジェクション）
- **4/5固定スコア問題対策**: スコアは1〜5の範囲で内容に応じて可変

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│ GitHub                                                                  │
│                                                                         │
│  PR作成/更新                                                             │
│      │                                                                  │
│      ▼                                                                  │
│  ┌──────────────────┐                                                   │
│  │ GitHub Actions   │                                                   │
│  │                  │                                                   │
│  │ 1. PR情報収集     │                                                   │
│  │ 2. ファイル一覧取得 │                                                   │
│  │ 3. Dify API呼出   │ ─────────────────┐                               │
│  │ 4. コメント投稿    │ ◀────────────────┼────────────────┐              │
│  └──────────────────┘                   │                │              │
│                                         │                │              │
└─────────────────────────────────────────┼────────────────┼──────────────┘
                                          │                │
                                          ▼                │
┌─────────────────────────────────────────────────────────────────────────┐
│ Dify Cloud                              │                │              │
│                                         │                │              │
│  ┌──────────────────┐                   │                │              │
│  │ Workflow         │                   │                │              │
│  │                  │                   │                │              │
│  │ 1. PR差分取得     │ ← GitHub REST API │                │              │
│  │    (HTTP×3ページ) │                   │                │              │
│  │                  │                   │                │              │
│  │ 2. データ整形     │                   │                │              │
│  │    (優先度ソート)  │                   │                │              │
│  │                  │                   │                │              │
│  │ 3. LLMレビュー    │ ───────────────────┼──┐            │              │
│  │                  │ ◀──────────────────┼──┼────────────┼──┐           │
│  │ 4. 結果返却      │ ───────────────────┼──┼────────────┘  │           │
│  └──────────────────┘                   │  │               │           │
│                                         │  │               │           │
└─────────────────────────────────────────┼──┼───────────────┼───────────┘
                                          │  │               │
                                          │  ▼               │
┌─────────────────────────────────────────────────────────────────────────┐
│ Azure OpenAI                            │                  │            │
│                                         │                  │            │
│  ┌──────────────────┐                   │                  │            │
│  │ GPT-4o           │ ◀─────────────────┘                  │            │
│  │                  │ ─────────────────────────────────────┘            │
│  │ コードレビュー実行 │                                                   │
│  └──────────────────┘                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## ファイル構成

```
.github/
└── workflows/
    └── pr-code-review-actions.yml    # GitHub Actions ワークフロー

dify/
└── pr-code-review-dify-workflow.yml  # Dify DSL
```

## セットアップ

### 1. Dify側の設定

#### 1.1 Azure OpenAIモデルの設定

1. Difyの **設定** → **モデルプロバイダー**
2. **Azure OpenAI** を追加
3. 以下の情報を入力：
   - Azure OpenAI エンドポイント
   - API Key
   - デプロイメント名（例: `gpt-4o`）

#### 1.2 ワークフローのインポート

1. Difyの **スタジオ** → **DSLをインポート**
2. `dify/pr-code-review-dify-workflow.yml` をアップロード
3. ワークフローを **公開**
4. **API アクセス** からAPIキーを取得

#### 1.3 環境変数の設定

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `GITHUB_TOKEN` | `ghp_xxxx...` | GitHub Personal Access Token（`repo`権限必須） |

> ⚠️ このGITHUB_TOKENはGitHub Actions側のものとは別に、Dify側で設定が必要です。

### 2. GitHub側の設定

#### 2.1 Secretsの設定

リポジトリの **Settings** → **Secrets and variables** → **Actions** で以下を設定：

| Secret名 | 値 | 説明 |
|----------|-----|------|
| `DIFY_API_KEY` | `app-xxxx...` | DifyワークフローのAPIキー |
| `DIFY_WORKFLOW_URL` | `https://api.dify.ai/v1/workflows/run` | Dify Workflow API URL |

#### 2.2 ワークフローファイルの配置

`.github/workflows/pr-code-review-actions.yml` を配置します。

## 使い方

セットアップ完了後、以下のタイミングで自動実行されます：

- PRの新規作成時（`opened`）
- PRへのpush時（`synchronize`）
- PRの再オープン時（`reopened`）
- ドラフトから通常PRへの変更時（`ready_for_review`）

### 対象外となるPR

- ドラフトPR
- ForkからのPR（セキュリティ上の理由）

## レビュー結果の例

```markdown
### 📊 総合評価
- スコア: 1〜5/5（内容に応じて可変）
- レビュー判定: COMMENT

### 📁 ファイル別コメント
| ファイル | コメント |
|---------|---------|
| src/auth.ts | ⚠️ エラーハンドリング改善を推奨 |
| src/types.ts | ✅ 問題なし |
```

## 制限事項

### ファイル数・サイズ制限

| 項目 | 制限値 | 備考 |
|------|--------|------|
| 最大ファイル数 | 300件 | GitHub REST API 3ページ分 |
| 詳細表示ファイル数 | 50件 | 優先度順 |
| ファイル毎のpatch | 4,000文字 | 超過分はトランケート |
| 合計文字数 | 120,000文字 | LLMコンテキスト対策 |
| LLM出力トークン | 4,096 | レビュー結果の最大長 |

### その他の制限

- **バイナリファイル**: patchは取得できないが、取得不可である旨のコメントは生成
- **ページネーション**: 最大3ページ（300ファイル）まで対応
- **ForkからのPR**: セキュリティ上、対象外
- **プロジェクト全体の理解**: 変更ファイルのみ参照（既存コードとの整合性チェックは限定的）

### ファイル優先度（Webサイト開発向け）

| 優先度 | カテゴリ | 対象ファイル |
|:------:|---------|-------------|
| 1 | フロントエンドコンポーネント | `.tsx`, `.jsx`, `.vue`, `.svelte` |
| 2 | JavaScript/TypeScript | `.ts`, `.js` |
| 3 | スタイルシート | `.css`, `.scss`, `.sass` |
| 4 | HTML・テンプレート | `.html`, `.ejs`, `.hbs` |
| 5 | テストファイル | `*.test.ts`, `*.spec.tsx` |
| 6 | 設定ファイル | `package.json`, `tsconfig.json` 等 |
| 7 | ドキュメント | `.md`, `.mdx` |
| 8 | 画像・アセット | `.svg`, `.png`, `.jpg` |
| 9 | インフラ・CI/CD | `Dockerfile`, `.github/workflows/` |
| 99 | 削除ファイル | - |

## トラブルシューティング

### レビューが実行されない

1. **ドラフトPRになっていないか確認**
   - ドラフトPRはスキップされます

2. **ForkからのPRでないか確認**
   - セキュリティ上、ForkからのPRは対象外です

3. **Secretsが正しく設定されているか確認**
   ```
   Settings → Secrets and variables → Actions
   - DIFY_API_KEY
   - DIFY_WORKFLOW_URL
   ```

### "Dify API returned HTTP 4xx" エラー

1. **DIFY_API_KEY の確認**
   - Difyの API アクセス画面から正しいキーをコピー

2. **DIFY_WORKFLOW_URL の確認**
   - ワークフローが公開されているか確認
   - URLが正しいか確認

3. **Dify環境変数の確認**
   - `GITHUB_TOKEN` が設定されているか確認
   - トークンに `repo` 権限があるか確認

### レビュー結果が途中で切れる

- 大規模PRの場合、LLMの出力トークン制限（4,096）に達する可能性があります
- PRを分割するか、`max_tokens` を増加してください（コスト増）

### 特定のファイルがレビューされない

1. **バイナリファイル**
   - 画像などのバイナリファイルはpatch情報がないためレビュー対象外

2. **大きすぎるファイル**
   - GitHubがpatchを省略する場合があります

3. **ファイル数超過**
   - 300ファイルを超えるPRは一部のみレビュー対象

## カスタマイズ

### ファイル優先度の変更

Dify DSLの `get_file_priority` 関数を編集することで、ファイルの優先度を変更できます。

### レビュー観点の変更

Dify DSLのLLMノードの `prompt_template` を編集することで、レビューの観点や出力フォーマットを変更できます。

### 対象イベントの変更

GitHub Actionsの `on.pull_request.types` を編集することで、トリガーとなるイベントを変更できます。

## 設計判断メモ

- **HTTP方式採用**
  - diff分割（MCP方式）の不確実性を回避し、ファイル単位レビューの完全性を優先
- **300ファイル制限**
  - LLMコンテキストとコストのバランス
- **4/5固定スコア問題対策**
  - 出力例に固定値を含めない

## 関連リンク

- [Dify Documentation](https://docs.dify.ai/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Azure OpenAI Service](https://azure.microsoft.com/en-us/products/ai-services/openai-service)
